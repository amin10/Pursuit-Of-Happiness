<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pursuit of Happiness</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <style type="text/css">

      html, body, #map-canvas { height: 400px; width: 500px; }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxif6DsCvG0_9W3yYk2XQ4D1NN9VWg2wE">
    </script>
    <script type="text/javascript">
      numClicks = 0
      function initialize() {
        var mapOptions = {
          center: { lat: 42.3061, lng: -71.0589},
          zoom: 8
        };
        var map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
        addClickListener(map);
      }
      google.maps.event.addDomListener(window, 'load', initialize);
      //Then adds the listener

        var mapOptions = {
          center: { lat: 42.3061, lng: -71.0589}, 
          zoom: 8 
        };

        var map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

      
      function addClickListener(map) {
           google.maps.event.addListener(map, 'click', function(event){                                                                                                                                                          
       if (numClicks >=2) {
           process();
       }
       if (numClicks % 2 == 0 ) {
           startLat = event.latLng.lat();
           startLong = event.latLng.lng()
           numClicks++;
       } else if (numClicks % 2 == 1) {
           endLat = event.latLng.lat();
           endLong = event.latLng.lng();
           numClicks++;
           clicked_coordinates =[[startLat,startLong],[endLat,endLong]]
           console.log(clicked_coordinates)
          }
         }); 
      } 

    </script>
    <script src = "http://maps.google.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script>
      //window.onload = addClickListener;
     
        function process() {
            var coordinates = locationToLatLong()
            coordinates = clicked_coordinates;
            var loc = coordinates[0]
            var des = coordinates[1]
            var data = [80,80,2] //get from database
            var points = algo(loc, des, data);
            displayOnMap(points)
            
        }

        function locationToLatLong() {
            console.log("This function is not being used");
            return null
            var location = document.getElementById("location").value ; 
            var destination = document.getElementById("destination").value;
            var xmlHttp = new XMLHttpRequest(); 
            xmlHttp.open("GET", "amanna.pythonanywhere.com/location="+location+"", true);
            xmlHttp.send(null)
            var locationCoordinates = xmlHttp.responseText
            var xmlHttp = new XMLHttpRequest(); 
            xmlHttp.open("GET", "amanna.pythonanywhere.com/location="+destination+"", true);
            xmlHttp.send(null)
            var destinationCoordinates = xmlHttp.responseText
            console.log(destinationCoordinates)
            return [locationCoordinates,destinationCoordinates] 
       }
       
	
/* source :: [Lat, Long] */
/* target :: [Lat, Long] */
/* data :: [Lat, Long, Score] */

function algo(source, target, data){
    solution = [0];
    direction = [target[0]-source[0], target[1]-source[1]];
    var magnitude = function(v){
        return  Math.sqrt(Math.pow(v[0], 2) + Math.pow(v[1], 2));
    }
    distance = magnitude(direction);

    unit_direction = [direction[0]/distance, direction[1]/distance];

    var project = function(point){
        dot = point[0]*unit_direction[0]+point[1]*unit_direction[1];
        s = Math.pow(magnitude(unit_direction), 2);
        return [dot/s * unit_direction[0], dot/s * unit_direction[1]];
    }

    var error = function(point){
        var projection = project(point);
        return magnitude([point[0]-projection[0], point[1]-projection[1]]);
    }

    var compare = function(a,b){
        var rank= function(x){
            return (x[0]-source[0])/unit_direction[0]
        }
        return rank(project(a)) - rank(project(b));
    }

    data.sort(compare);

    source.push(1); //Neutral score
    target.push(1); //Neutral score

    //Remove out of range items:
    while(data.length>0 && compare(data[0], source) < 0) {
        data.shift();
    }
    while(data.length>0 && compare(data[data.length-1], target) > 0){
        data.pop();
    }

    //Prepend Source vertex.
    data.unshift(source);
    //Append Target vertex.
    data.push(target);

    /*----------------------------------*/
    /* Data is now topologically sorted */
    // console.log("topologically sorted: ", data);

    /*----------------------------------*/
    var w = function(i,j){
        var a = data[i];
        var b = data[j];
        return Math.sqrt(Math.pow(b[0]-a[0], 2) + Math.pow(b[1]-a[1], 2)) / b[2] + error(b);
    }
    memo = {};
    child = {};
    var shortest = function(i){
        if (i >= data.length-1){
            return 0;//Reached Target.
        }
        if( i in memo ){
            return memo[i];
        }
        var best_length = Number.POSITIVE_INFINITY;
        var best_j = null;
        var j;
        for (j = i+1; j < data.length; j++) { 
            var cur_length = shortest(j) + w(i, j);
            if(cur_length < best_length){
                best_length = cur_length;
                best_j = j;
            }
        }
        if(best_j === null){
            return;
        }
        memo[i] = shortest(best_j) + w(i,best_j);
        child[i] = best_j;
        return memo[i];
    }

    console.log(shortest(0));
    root = 0;
    path = [data[root]];
    while (root < data.length-1){
        root = child[root]
        path.push(data[root]);
    }
    return path;
}

    function displayOnMap() {
    var mapOptions = {
          center: { lat: 42.3061, lng: -71.0589},
          zoom: 8
        };
      var map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

    var points = [[42.3351, -71.1704],[42.3496,-71.0997],[42.3598,-71.0921]];
    var pathCoordinates = [];
    for (var i = 0; i < points.length; i++) {
          pathCoordinates.push(new google.maps.LatLng(points[i][0], points[i][1]));
    }
    var fullBounds = new google.maps.LatLngBounds();
    fullBounds.extend(pathCoordinates[0]);
    fullBounds.extend(pathCoordinates[points.length-1]);
    map.fitBounds(fullBounds);

    var happyPath = new google.maps.Polyline({
      path: pathCoordinates,
      geodesic: true,
      strokeColor: '#FF0000',
      strokeOpacity: 1.0,
      strokeWeight: 2
     });
    happyPath.setMap(map);
    }

    




 
    </script>
</head>
<body>


 <div class="container">
  <div class="jumbotron">
    <h1>Pursuit of Happiness</h1>
    <p>Make friends on the happiest route!</p>
  </div>
  <div class="row">
    <div class="col-sm-12">
      <h3>How it works </h3>
    </div>
  </div>
  <div class="row">
    <div class ="col-sm-4">
      <h3>Location and Destination</h3>
       
      <form class="form-horizontal" role="form">
          <div class="form-group">
          <label class="control-label col-sm-2" for="location">From:</label>
              <div class="col-sm-10">
                  <input type="textarea" class="form-control" id="location" placeholder="Enter current location">
              </div>
          </div>
          <div class="form-group">
              <label class="control-label col-sm-2" for="destination">To:</label>
              <div class="col-sm-10">
                  <input type="textarea" class="form-control" id="destination" placeholder="Enter destination">
              </div>
          </div>
         <div class="form-group">
             <div class="col-sm-offset-2 col-sm-10">
                 <button onclick="process()" type="submit" class="btn btn-default">Submit</button>
             </div>
         </div>
     </form>


      <p>Our algorithm will then calculate the happiest path for you </p>
    </div>
    <div class="col-sm-8">
      <h3>Map</h3>
      <p>This is where the map will go</p>
      <div id="map-canvas"></div>
    </div>
  </div>
</div>
</body>

</html>

